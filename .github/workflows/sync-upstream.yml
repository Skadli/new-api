name: æ¯å‘¨åŒæ­¥ä¸Šæ¸¸å¹¶åº”ç”¨å“ç‰Œ

# è¯´æ˜ï¼š
# - å®šæ—¶ä¸æ‰‹åŠ¨è§¦å‘ï¼Œä»ä¸Šæ¸¸ä»“åº“æ‹‰å–æœ€æ–°ä»£ç ï¼ŒåŒæ­¥åˆ°å½“å‰ä»“åº“æ ¹ç›®å½•ã€‚
# - è·³è¿‡æœ¬ä»“åº“çš„ .github/ã€tools/ã€branding/ ç›®å½•ï¼Œé¿å…è¦†ç›–å·¥ä½œæµä¸å“ç‰Œèµ„æºã€‚
# - åŒæ­¥åè¦†ç›– web/favicon.ico ä¸ web/logo.pngï¼ˆè‹¥ branding/ ä¸‹æä¾›ï¼‰ï¼Œ
#   å¹¶åœ¨ web/ ç›®å½•å†…å°†æ‰€æœ‰ "NEW-api" æ–‡æœ¬æ›¿æ¢ä¸º "meAPI"ï¼ˆå¯é€šè¿‡å˜é‡è‡ªå®šä¹‰ï¼‰ã€‚

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 2 * * 1" # æ¯å‘¨ä¸€ 02:00 (UTC) è¿è¡Œä¸€æ¬¡

permissions:
  contents: write
  actions: write

concurrency:
  group: sync-upstream
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ‰§è¡ŒåŒæ­¥ä¸å“ç‰Œæ›¿æ¢é€»è¾‘
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ”§ åˆå§‹åŒ–å‚æ•°ï¼ˆAction å†…è”é€»è¾‘ï¼Œæ— éœ€è„šæœ¬ï¼‰"
          upstream_url="https://github.com/QuantumNous/new-api.git"
          upstream_dir="upstream-src"
          branding_dir="branding"
          web_dir="web"
          sync_branch="${GITHUB_REF_NAME:-main}"

          echo "ğŸ” ä¸Šæ¸¸ä»“åº“ï¼š${upstream_url}"
          echo "ğŸ“¦ å…‹éš†ä¸Šæ¸¸ï¼ˆæµ…å…‹éš†ï¼‰..."
          rm -rf "${upstream_dir}"
          git clone --depth=1 "${upstream_url}" "${upstream_dir}"
          if ! upstream_default_branch=$(git -C "${upstream_dir}" symbolic-ref --short refs/remotes/origin/HEAD 2>/dev/null | sed 's@^origin/@@'); then
            if git -C "${upstream_dir}" rev-parse --verify origin/main >/dev/null 2>&1; then upstream_default_branch=main; else upstream_default_branch=master; fi
          fi
          upstream_sha=$(git -C "${upstream_dir}" rev-parse "origin/${upstream_default_branch}")
          echo "ğŸ“Œ ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯ï¼š${upstream_default_branch} @ ${upstream_sha}"

          echo "ğŸ§­ å¯¹é½åˆ°æœ€æ–°çš„ç›®æ ‡åˆ†æ”¯æäº¤ï¼Œé¿å…åç»­æ¨é€è¢«æ‹’ç»"
          git config pull.rebase true
          git fetch origin "${sync_branch}" || true
          # è‹¥è¿œç«¯åˆ†æ”¯å­˜åœ¨åˆ™åŸºäºå…¶åˆ›å»º/é‡ç½®æœ¬åœ°åˆ†æ”¯ï¼Œå¦åˆ™ç›´æ¥åˆ›å»ºæœ¬åœ°åˆ†æ”¯
          if git rev-parse --verify "origin/${sync_branch}" >/dev/null 2>&1; then
            git checkout -B "${sync_branch}" "origin/${sync_branch}"
          else
            git checkout -B "${sync_branch}"
          fi

          echo "ğŸšš åŒæ­¥æ–‡ä»¶åˆ°å½“å‰ä»“åº“ï¼ˆä¿ç•™ .github/ã€${branding_dir}/ã€tools/ï¼Œå¹¶å¿½ç•¥ ${upstream_dir}/ è‡ªèº«ï¼‰..."
          set +e
          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "${branding_dir}" \
            --exclude "tools" \
            --exclude "${upstream_dir}" \
            "${upstream_dir}"/ ./
          rs=$?
          set -e
          if [[ $rs -eq 24 ]]; then
            echo "âš ï¸ rsync è­¦å‘Š(code 24)ï¼šéƒ¨åˆ†æ–‡ä»¶åœ¨ä¼ è¾“å‰æ¶ˆå¤±ï¼Œé€šå¸¸ä¸ºä¸´æ—¶æ–‡ä»¶æˆ–è¢«åˆ é™¤çš„ç›®æ ‡ï¼›å·²å¿½ç•¥å¹¶ç»§ç»­ã€‚"
          elif [[ $rs -ne 0 ]]; then
            echo "âŒ rsync å¤±è´¥ï¼Œé€€å‡ºç ï¼š$rs"
            exit $rs
          fi

          echo "ğŸ¨ è¦†ç›–å“ç‰Œå›¾æ ‡ï¼ˆå…¼å®¹ web ä¸ web/publicï¼‰"
          if [ -d "${web_dir}" ]; then
            if [ -f "${branding_dir}/favicon.ico" ]; then
              echo "  - è¦†ç›– ${web_dir}/favicon.ico"
              cp -f "${branding_dir}/favicon.ico" "${web_dir}/favicon.ico"
            fi
            if [ -f "${branding_dir}/logo.png" ]; then
              echo "  - è¦†ç›– ${web_dir}/logo.png"
              cp -f "${branding_dir}/logo.png" "${web_dir}/logo.png"
            fi
            if [ -d "${web_dir}/public" ]; then
              if [ -f "${branding_dir}/favicon.ico" ]; then
                echo "  - è¦†ç›– ${web_dir}/public/favicon.ico"
                cp -f "${branding_dir}/favicon.ico" "${web_dir}/public/favicon.ico"
              fi
              if [ -f "${branding_dir}/logo.png" ]; then
                echo "  - è¦†ç›– ${web_dir}/public/logo.png"
                cp -f "${branding_dir}/logo.png" "${web_dir}/public/logo.png"
              fi
            fi
          
            echo "ğŸ“ éå† ${web_dir} å†…çš„æ–‡æœ¬æ–‡ä»¶å¹¶æ›¿æ¢"
            find "${web_dir}" -type f -print0 | while IFS= read -r -d '' f; do
              if file -b --mime-type "$f" | grep -q '^text/'; then
                perl -0777 -i -pe 's/\QNEW-api\E/meAPI/g' "$f"
                perl -0777 -i -pe 's/\Qnew-api\E/meAPI/g' "$f"
                perl -0777 -i -pe 's#/logo\.png#https://r2.690990.xyz/logo.png#g' "$f"
              fi
            done

            echo "ğŸ§© åº”ç”¨é¡µé¢ä¸è„šæ‰‹æ¶å®šåˆ¶ï¼ˆmeta æè¿°ã€Footer æ³¨é‡Šã€æ§åˆ¶å°è¾“å‡ºæ³¨é‡Šï¼‰"
            # 1) è¦†ç›–ä»»æ„ meta description çš„ content å€¼ä¸ºç›®æ ‡æè¿°
            if [[ -f "${web_dir}/index.html" ]]; then
              perl -0777 -i -pe 's/(<meta\s+name="description"[^>]*content=")[^"]*(")/$1é«˜é€Ÿç¨³å®šçš„AI APIä»£ç†å¹³å°ï¼Œæ”¯æŒå›½å†…å¤–æ‰€æœ‰ä¸»æµAIæ¨¡å‹APIæ¥å…¥ï¼Œæ— è®ºGPTã€Claudeã€geminiæˆ–å…¶ä»–æ¨¡å‹å‡å¯å¿«é€Ÿè°ƒç”¨ï¼Œè½»æ¾å®ç°å…¨æ¨¡å‹æ¥å…¥ï¼Œä¿éšœé«˜å¯ç”¨æ€§ä¸ä½å»¶è¿Ÿã€‚$2/i' "${web_dir}/index.html"
              # åŒæ­¥ SYNC.md è¿½åŠ è¦æ±‚ï¼šæ›¿æ¢ <title>New API</title> â†’ <title>me API</title>
              perl -0777 -i -pe 's#<title>\s*New API\s*</title>#<title>me API</title>#ig' "${web_dir}/index.html"
            fi

            # 2) æ³¨é‡Š Footer.jsx ä¸¤æ®µä»£ç å—ï¼ˆå¹‚ç­‰å¤„ç†ï¼Œå·²æ³¨é‡Šåˆ™è·³è¿‡ï¼‰
            footer_jsx="${web_dir}/src/components/layout/Footer.jsx"
            if [[ -f "${footer_jsx}" ]]; then
              perl -0777 -i -pe 's{(<div className=["\x27]text-sm["\x27]>[\s\S]*?</div>)}{ my $b=$1; $b =~ /^\s*\{\/\*/s ? $b : "{/* $b */}" }gse' "${footer_jsx}"
              perl -0777 -i -pe 's{(<div className=["\x27]absolute bottom-2 right-4 text-xs !text-semi-color-text-2 opacity-70["\x27]>[\s\S]*?</div>)}{ my $b=$1; $b =~ /^\s*\{\/\*/s ? $b : "{/* $b */}" }gse' "${footer_jsx}"
            fi

            # 3) æ³¨é‡Š index.jsx çš„æ§åˆ¶å°è¾“å‡ºå—ï¼ˆå¹‚ç­‰ï¼‰
            idx_jsx="${web_dir}/src/index.jsx"
            if [[ -f "${idx_jsx}" ]]; then
              perl -0777 -i -pe 's{(if\s*\(typeof\s+window\s*!==\s*["\x27]undefined["\x27]\)\s*\{[\s\S]*?\})}{ my $b=$1; $b =~ m#^\s*/\*#s ? $b : "/* $b */" }gse' "${idx_jsx}"
            fi
          else
            echo "âš ï¸ æœªå‘ç° ${web_dir} ç›®å½•ï¼Œè·³è¿‡å“ç‰Œè¦†ç›–ä¸æ–‡æ¡ˆæ›¿æ¢"
          fi

          echo "ğŸ“¤ å‡†å¤‡æäº¤ä¸æ¨é€"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "âœ… æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´ï¼ˆä¸ä¸Šæ¸¸ä¸€è‡´æˆ–å“ç‰Œæœªå˜åŒ–ï¼‰"
            exit 0
          fi
          git commit -m "chore(sync): æ¯å‘¨åŒæ­¥ä¸Šæ¸¸(${upstream_default_branch} ${upstream_sha}) + å“ç‰Œè¦†ç›–(web & public) + æ–‡æ¡ˆæ›¿æ¢(NEW-api/new-apiâ†’meAPI, /logo.png é“¾æ¥) + æ›´æ–° index.html æè¿° + æ³¨é‡Š Footer ä¸¤æ®µ + æ³¨é‡Šæ§åˆ¶å°è¾“å‡º"

          echo "ğŸšš æ¨é€å˜æ›´ï¼ˆå«è¢«æ‹’ç»æ—¶çš„ rebase é‡è¯•ï¼‰"
          attempt=1
          max_attempts=3
          while true; do
            if git push origin "HEAD:${sync_branch}"; then
              break
            fi
            if [ ${attempt} -ge ${max_attempts} ]; then
              echo "âŒ Push è¢«æ‹’ç»ä¸”é‡è¯• ${max_attempts} æ¬¡ä»å¤±è´¥ã€‚å¯è€ƒè™‘ä½¿ç”¨å—ä¿æŠ¤åˆ†æ”¯çš„ PR æµç¨‹æˆ–å…è®¸ --force-with-leaseã€‚";
              exit 1
            fi
            echo "âš ï¸ Push è¢«æ‹’ç»ï¼Œæ‰§è¡Œ rebase åé‡è¯•ï¼ˆç¬¬ ${attempt} æ¬¡ï¼‰"
            git fetch origin "${sync_branch}" || true
            if ! git rebase "origin/${sync_branch}"; then
              echo "âš ï¸ rebase å‘ç”Ÿå†²çªï¼Œå°è¯•æ”¾å¼ƒ rebase å¹¶ä½¿ç”¨ --force-with-lease å®‰å…¨è¦†ç›–ï¼ˆè‹¥åˆ†æ”¯å—ä¿æŠ¤ï¼Œæ­¤æ“ä½œä¼šå¤±è´¥ï¼‰"
              git rebase --abort || true
              if git push --force-with-lease origin "HEAD:${sync_branch}"; then
                break
              else
                attempt=$((attempt+1))
                continue
              fi
            fi
            attempt=$((attempt+1))
          done
          echo "ğŸš€ åŒæ­¥å®Œæˆï¼Œå·²æ¨é€åˆ°åˆ†æ”¯ï¼š${sync_branch}"
